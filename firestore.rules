
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Checks the user's document in the 'users' collection to determine if they are an admin.
    function userIsAdmin(uid) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(uid)).data.isAdmin == true;
    }

    // --- Admin has full access ---
    // This rule gives any user marked as admin in their user document full read/write access to everything.
    match /{document=**} {
      allow read, write: if userIsAdmin(request.auth.uid);
    }
    
    // --- User Profile Rules for non-admins ---
    match /users/{userId} {
      // Users can read their own profile.
      allow get: if isUser(userId);
      // Logged-in users can read other user profiles for display purposes (e.g., names).
      allow list: if isSignedIn();
    }

    // --- General Read-Only Rules for non-admins ---
    // Logged-in users can read data needed for reports and general UI.
    match /groups/{groupId} {
      allow get, list: if isSignedIn();
    }
    match /members/{memberId} {
      allow get, list: if isSignedIn();
    }
    match /payments/{paymentId} {
      allow get, list: if isSignedIn();
    }
    match /expenses/{expenseId} {
      allow get, list: if isSignedIn();
    }
    match /contributionSettings/{settingId} {
        allow get, list: if isSignedIn();
    }
    match /notes/{noteId} {
        allow get, list: if isSignedIn();
    }
  }
}
